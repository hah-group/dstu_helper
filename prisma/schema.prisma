// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  key                Int                @key
  socialType        SocialType
  firstName         String
  lastName          String?
  groupId           Int?
  stage             String             @default("NOT_PRIVATE_STARTED")
  menu              Json?
  locale            String             @default("ru")
  Group             StudyGroup?        @relation(fields: [groupId], references: [key])
  ConversationUsers ConversationUser[]
}

model Conversation {
  key                Int                @key
  title             String?
  settings          Json
  ConversationUsers ConversationUser[]
  status            ConversationStatus @default(NOT_CONFIGURED)
}

model ConversationUser {
  key             Int          @key @default(autoincrement())
  fromId         Int
  conversationId Int
  role           Role
  User           User         @relation(fields: [fromId], references: [key])
  Conversation   Conversation @relation(fields: [conversationId], references: [key])

  @@unique([fromId, conversationId])
}

model StudyGroup {
  key           Int          @key
  name         String       @unique
  updateStatus UpdateStatus @default(DONE)
  Lessons      Lesson[]
  Users        User[]
}

model Lesson {
  key         String     @key
  groupId    Int
  start      DateTime   @db.Timestamp
  end        DateTime   @db.Timestamp
  isTopWeek  Boolean
  type       LessonType
  order      Int
  name       String
  teacherId  Int?
  subgroup   Int?
  subsection String?
  corpus     String?
  classRoom  String?
  distance   Boolean
  updateAt   DateTime   @default(now())
  Group      StudyGroup @relation(fields: [groupId], references: [key])
  Teacher    Teacher?   @relation(fields: [teacherId], references: [key])
}

model Teacher {
  key         Int      @key
  firstName  String?
  lastName   String
  middleName String?
  Lessons    Lesson[]
}

enum Role {
  STUDENT
  HEADMAN_UNCHECKED
  INVITING
  ADMIN
  HEADMAN
}

enum UpdateStatus {
  DONE
  IN_PROGRESS
  FAILURE
}

enum LessonType {
  LECTURE
  PRACTICAL
  LABORATORY
  EXAMINATION
  EXAM_WITHOUT_MARK
}

enum ConversationStatus {
  NOT_CONFIGURED
  LIMITED
  FULL
}

enum SocialType {
  VK
  TELEGRAM
}
